<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¬æµ· èŠå¤©ä¿¡æ¯æ€»ç»“</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f5f5f5; 
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* å·¦ä¾§è¾¹æ  - ç¾¤ç»„/è§’è‰²ç®¡ç† */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #007bff;
            color: white;
        }
        
        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .account-info {
            font-size: 12px;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .add-group-btn {
            width: 100%;
            padding: 8px;
            background: white;
            color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-group-btn:hover {
            background: #f0f0f0;
        }
        
        .groups-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .group-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .group-item:hover {
            background: #e9ecef;
        }
        
        .group-item.active {
            background: #e7f3ff;
            border-color: #007bff;
        }
        
        .group-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .group-name {
            font-weight: bold;
            color: #333;
        }
        
        .group-actions {
            display: flex;
            gap: 5px;
        }
        
        .group-btn {
            padding: 2px 6px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        
        .group-btn.delete {
            background: #dc3545;
        }
        
        .group-prompt {
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ä¸»èŠå¤©åŒºåŸŸ */
        .main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .main-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-header h1 {
            font-size: 24px;
            color: #333;
        }
        
        .chat-container {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background-color: #f1f1f1;
            color: #333;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        /* Markdown æ ·å¼ */
        .ai-message h1, .ai-message h2, .ai-message h3, .ai-message h4, .ai-message h5, .ai-message h6 {
            margin: 10px 0 5px 0;
            font-weight: bold;
        }
        
        .ai-message h1 { font-size: 1.5em; }
        .ai-message h2 { font-size: 1.3em; }
        .ai-message h3 { font-size: 1.1em; }
        
        .ai-message p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .ai-message ul, .ai-message ol {
            margin: 8px 0;
            padding-left: 25px;
        }
        
        .ai-message li {
            margin: 4px 0;
        }
        
        .ai-message pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .ai-message code {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .ai-message pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        
        .ai-message blockquote {
            border-left: 4px solid #007bff;
            padding-left: 12px;
            margin: 10px 0;
            color: #666;
            font-style: italic;
        }
        
        .ai-message table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        
        .ai-message table th,
        .ai-message table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .ai-message table th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        
        .ai-message a {
            color: #007bff;
            text-decoration: none;
        }
        
        .ai-message a:hover {
            text-decoration: underline;
        }
        
        .ai-message hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 15px 0;
        }
        
        .ai-message strong {
            font-weight: bold;
        }
        
        .ai-message em {
            font-style: italic;
        }
        
        .mention-tag {
            background: #ffc107;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .input-area {
            position: relative;
            background: white;
            padding: 15px;
            border-top: 1px solid #eee;
            border-radius: 10px;
        }
        
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        #user-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }
        
        #user-input:focus {
            border-color: #007bff;
        }
        
        .mention-dropdown {
            position: absolute;
            bottom: 100%;
            left: 15px;
            margin-bottom: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            width: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .mention-dropdown.show {
            display: block;
        }
        
        .mention-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .mention-item:hover {
            background: #f0f0f0;
        }
        
        .mention-item:last-child {
            border-bottom: none;
        }
        
        button {
            padding: 10px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            flex-shrink: 0;
        }

        .modal-content.login-content {
            max-width: 400px;
            height: auto;
            width: 90%;
        }

        .form-group {
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .form-group.full-height {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        /* é’ˆå¯¹ç™»å½•æ¡†çš„ç‰¹æ®Šå¤„ç† */
        .login-content .form-group.full-height {
            flex-grow: 0;
            min-height: auto;
            overflow: visible;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            flex-shrink: 0;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: none;
            flex-grow: 1;
            height: 100%; /* ç¡®ä¿å¡«æ»¡çˆ¶å®¹å™¨ */
            font-family: 'Courier New', Courier, monospace;
            line-height: 1.4;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-cancel {
            background: #6c757d;
        }
        
        .btn-cancel:hover {
            background: #5a6268;
        }
        
        /* æ¸…é™¤å†å²æŒ‰é’® */
        .btn-clear {
            background: #dc3545;
            padding: 8px 15px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .btn-clear:hover {
            background: #c82333;
        }
        
        /* å†å²ä¿¡æ¯æç¤º */
        .history-info {
            text-align: center;
            padding: 8px;
            background: #e7f3ff;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>èŠå¤©è”ç³»äººç®¡ç†</h2>
                <div id="account-display" class="account-info" style="display:none">å½“å‰è´¦å·: <span id="current-account"></span></div>
                <button class="add-group-btn" onclick="openGroupModal()">+ æ·»åŠ è¦åˆ†æçš„èŠå¤©äºº/ç¾¤</button>
            </div>
            <div class="groups-list" id="groups-list">
                <!-- ç¾¤ç»„åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="main-area">
            <div class="main-header">
                <h1>å¬æµ· èŠå¤©ä¿¡æ¯æ€»ç»“</h1>
                <button onclick="clearHistory()" class="btn-clear">ğŸ—‘ï¸ æ¸…é™¤å¯¹è¯å†å²</button>
            </div>
            <div class="chat-container">
                <div id="history-info" class="history-info" style="display: none;"></div>
                <div id="chat-history"></div>
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯... (ä½¿ç”¨ @ æåŠè§’è‰²)" onkeypress="handleKeyPress(event)" oninput="handleInput(event)"></textarea>
                        <button onclick="sendMessage()" id="send-btn">å‘é€</button>
                    </div>
                    <div class="mention-dropdown" id="mention-dropdown"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal" data-backdrop="static">
        <div class="modal-content login-content">
            <h3>ç™»å½• / è®¾ç½®è´¦å·</h3>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">è¯·è¾“å…¥æ‚¨çš„è´¦å·IDå’Œå¯†ç ï¼ˆéœ€ä¸Parse Clienté…ç½®ä¸€è‡´ï¼‰</p>
            <div class="form-group">
                <label for="login-account">è´¦å·IDï¼š</label>
                <input type="text" id="login-account" placeholder="ä¾‹å¦‚ï¼šZhangSan1" />
            </div>
            <div class="form-group">
                <label for="login-password">å¯†ç ï¼š</label>
                <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " />
            </div>
            <div class="modal-actions">
                <button onclick="handleLogin()">ç¡®è®¤ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç¾¤ç»„æ¨¡æ€æ¡† -->
    <div class="modal" id="group-modal">
        <div class="modal-content">
            <h3 id="modal-title">æ·»åŠ è¦åˆ†æçš„èŠå¤©äºº/ç¾¤</h3>
            <div class="form-group">
                <label for="group-name-input">èŠå¤©è”ç³»äºº/ç¾¤åç§°ï¼š</label>
                <input type="text" id="group-name-input" placeholder="ä¾‹å¦‚ï¼šç›¸äº²ç›¸çˆ±ä¸€å®¶äºº" />
            </div>
            <div class="form-group full-height">
                <label for="group-prompt-input">åˆ†ææç¤ºè¯ (Prompt)ï¼š</label>
                <textarea id="group-prompt-input" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä½èµ„æ·±çš„ç¾¤è¿è¥äººå‘˜ï¼Œæ“…é•¿åˆ†æ/æ€»ç»“ç¾¤èŠä¿¡æ¯..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeGroupModal()">å–æ¶ˆ</button>
                <button onclick="saveGroup()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬å»¶è¿ŸåŠ è½½ï¼Œä¼˜åŒ–é¦–å±æ¸²æŸ“é€Ÿåº¦ -->
    <!-- Prefer self-hosted assets for reliability/security (avoid third-party CDN runtime dependency) -->
    <link rel="stylesheet" href="static/vendor/highlightjs/github.min.css">
    <script src="static/vendor/marked/marked.min.js"></script>
    <script src="static/vendor/highlightjs/highlight.min.js"></script>

    <script>
        // -----------------------------------------------------------------------------
        // CDN Robust Loader (Production-safe):
        // - Do NOT disable TLS verification in clients.
        // - If a CDN is blocked/unreachable, fall back to another CDN.
        // - If still unavailable, gracefully degrade to plain-text rendering.
        // -----------------------------------------------------------------------------
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.onload = () => resolve(true);
                s.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.head.appendChild(s);
            });
        }

        let _markedConfigured = false;
        function configureMarkedIfReady() {
            if (_markedConfigured) return;
            if (typeof marked === 'undefined') return;
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false,
            });
            _markedConfigured = true;
        }

        async function ensureMarked() {
            // In production we self-host JS under /static. If it's still missing, degrade to plain text.
            if (typeof marked !== 'undefined') {
                configureMarkedIfReady();
                return true;
            }
            return false;
        }

        async function ensureHljs() {
            if (typeof hljs !== 'undefined') return true;
            return false;
        }

        // é…ç½® marked.js
        if (typeof marked !== 'undefined') {
             marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
        }
        
        // é…ç½®ä»£ç é«˜äº®
        if (typeof hljs !== 'undefined') {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (err) {}
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });
            }
        }
        
        // å…¨å±€çŠ¶æ€
        let groups = [];
        let currentEditingId = null;
        let mentionStartPos = -1;
        let currentAccount = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            updateHistoryInfo();
        });
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            // ç®€å•æ£€æŸ¥ session storage
            const account = sessionStorage.getItem('account');
            if (account) {
                performLogin(account);
            } else {
                document.getElementById('login-modal').classList.add('show');
            }
        }
        
        async function handleLogin() {
            const inputAccount = document.getElementById('login-account');
            const inputPassword = document.getElementById('login-password');
            const account = inputAccount.value.trim();
            const password = inputPassword.value.trim();
            
            if(!account) {
                alert("è¯·è¾“å…¥è´¦å·");
                return;
            }
            if(!password) {
                alert("è¯·è¾“å…¥å¯†ç ");
                return;
            }
            
            try {
                // IMPORTANT: Use relative paths for API calls to support URL prefixes automatically
                const res = await fetch('api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ account, password })
                });
                
                if(res.ok) {
                    sessionStorage.setItem('account', account);
                    performLogin(account);
                    document.getElementById('login-modal').classList.remove('show');
                } else if (res.status === 401) {
                    alert("ç™»å½•å¤±è´¥ï¼šè´¦å·æˆ–å¯†ç é”™è¯¯");
                } else {
                    alert("ç™»å½•å¤±è´¥ï¼šæœåŠ¡å™¨é”™è¯¯");
                }
            } catch(e) {
                alert("ç™»å½•å‡ºé”™: " + e.message);
            }
        }
        
        function performLogin(account) {
            currentAccount = account;
            document.getElementById('current-account').textContent = account;
            document.getElementById('account-display').style.display = 'block';
            loadGroups();
        }
        
        // åŠ è½½ç¾¤ç»„æ•°æ®
        async function loadGroups() {
            if(!currentAccount) return;
            try {
                const res = await fetch('api/groups');
                if(res.ok) {
                    groups = await res.json();
                    renderGroups();
                }
            } catch(e) {
                console.error("Failed to load groups", e);
            }
        }
        
        // æ¸²æŸ“ç¾¤ç»„åˆ—è¡¨
        function renderGroups() {
            const container = document.getElementById('groups-list');
            if (groups.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">æš‚æ— è”ç³»äººï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
                return;
            }
            
            container.innerHTML = groups.map(group => `
                <div class="group-item" id="group-${group.id}">
                    <div class="group-item-header">
                        <span class="group-name">@${group.name}</span>
                        <div class="group-actions">
                            <button class="group-btn" onclick="editGroup('${group.id}')">ç¼–è¾‘</button>
                            <button class="group-btn delete" onclick="deleteGroup('${group.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="group-prompt">${group.prompt || 'æ— æç¤ºè¯'}</div>
                </div>
            `).join('');
        }
        
        // æ‰“å¼€ç¾¤ç»„æ¨¡æ€æ¡†
        function openGroupModal(groupId = null) {
            currentEditingId = groupId;
            const modal = document.getElementById('group-modal');
            const title = document.getElementById('modal-title');
            const nameInput = document.getElementById('group-name-input');
            const promptInput = document.getElementById('group-prompt-input');
            
            if (groupId) {
                const group = groups.find(g => g.id === groupId);
                title.textContent = 'ç¼–è¾‘èŠå¤©è”ç³»äºº';
                nameInput.value = group.name;
                promptInput.value = group.prompt;
            } else {
                title.textContent = 'æ·»åŠ è¦åˆ†æçš„èŠå¤©äºº/ç¾¤';
                nameInput.value = '';
                promptInput.value = '';
            }
            
            modal.classList.add('show');
        }
        
        // å…³é—­ç¾¤ç»„æ¨¡æ€æ¡†
        function closeGroupModal() {
            document.getElementById('group-modal').classList.remove('show');
            currentEditingId = null;
        }
        
        // ä¿å­˜ç¾¤ç»„
        async function saveGroup() {
            const name = document.getElementById('group-name-input').value.trim();
            const prompt = document.getElementById('group-prompt-input').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥è”ç³»äººåç§°');
                return;
            }
            
            const groupData = {
                name: name,
                prompt: prompt
            };
            
            if (currentEditingId) {
                groupData.id = currentEditingId;
            }
            
            try {
                const res = await fetch('api/groups', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(groupData)
                });
                
                if(res.ok) {
                    await loadGroups(); // Reload
                    closeGroupModal();
                } else {
                    alert("ä¿å­˜å¤±è´¥");
                }
            } catch(e) {
                alert("ä¿å­˜å‡ºé”™: " + e.message);
            }
        }
        
        // ç¼–è¾‘ç¾¤ç»„
        function editGroup(id) {
            openGroupModal(id);
        }
        
        // åˆ é™¤ç¾¤ç»„
        async function deleteGroup(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè”ç³»äººå—ï¼Ÿ')) {
                try {
                    const res = await fetch(`api/groups/${id}`, { method: 'DELETE' });
                    if(res.ok) {
                        loadGroups();
                    } else {
                        alert("åˆ é™¤å¤±è´¥");
                    }
                } catch(e) {
                    alert("åˆ é™¤å‡ºé”™: " + e.message);
                }
            }
        }
        
        // å¤„ç†è¾“å…¥
        function handleInput(event) {
            const input = event.target;
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            // æ£€æŸ¥æ˜¯å¦è¾“å…¥äº† @
            const beforeCursor = text.substring(0, cursorPos);
            const lastAtIndex = beforeCursor.lastIndexOf('@');
            
            if (lastAtIndex !== -1) {
                const afterAt = beforeCursor.substring(lastAtIndex + 1);
                // å¦‚æœ @ åæ²¡æœ‰ç©ºæ ¼ï¼Œæ˜¾ç¤ºæåŠä¸‹æ‹‰æ¡†
                if (!/\s/.test(afterAt)) {
                    mentionStartPos = lastAtIndex;
                    showMentionDropdown(afterAt);
                    return;
                }
            }
            
            hideMentionDropdown();
        }
        
        // æ˜¾ç¤ºæåŠä¸‹æ‹‰æ¡†
        function showMentionDropdown(query) {
            const dropdown = document.getElementById('mention-dropdown');
            const filtered = groups.filter(g => g.name.toLowerCase().includes(query.toLowerCase()));
            
            if (filtered.length === 0) {
                hideMentionDropdown();
                return;
            }
            
            dropdown.innerHTML = filtered.map(group => `
                <div class="mention-item" onclick="selectMention('${group.name}')">
                    @${group.name}
                </div>
            `).join('');
            
            dropdown.classList.add('show');
        }
        
        // éšè—æåŠä¸‹æ‹‰æ¡†
        function hideMentionDropdown() {
            document.getElementById('mention-dropdown').classList.remove('show');
            mentionStartPos = -1;
        }
        
        // é€‰æ‹©æåŠ
        function selectMention(name) {
            const input = document.getElementById('user-input');
            const text = input.value;
            const before = text.substring(0, mentionStartPos);
            const after = text.substring(input.selectionStart);
            
            input.value = before + '@' + name + ' ' + after;
            input.focus();
            
            hideMentionDropdown();
        }
        
        // å¤„ç†æŒ‰é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // æå–æ¶ˆæ¯ä¸­çš„ @ æåŠ
        function extractMentions(text) {
            const mentions = [];
            const regex = /@(\S+)/g;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                const mentionedName = match[1];
                const group = groups.find(g => g.name === mentionedName);
                if (group) {
                    mentions.push(group);
                }
            }
            
            return mentions;
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const btn = document.getElementById('send-btn');
            const history = document.getElementById('chat-history');
            const text = input.value.trim();
            
            if (!text) return;
            
            // æå–æåŠçš„ç¾¤ç»„
            const mentions = extractMentions(text);
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«æåŠæ ‡ç­¾ï¼‰- ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º
            let displayText = escapeHtml(text);
            mentions.forEach(group => {
                displayText = displayText.replace(
                    new RegExp(escapeRegex(`@${group.name}`), 'g'),
                    `<span class="mention-tag">@${group.name}</span>`
                );
            });
            
            history.innerHTML += `<div class="message user-message">${displayText}</div>`;
            input.value = '';
            btn.disabled = true;
            history.scrollTop = history.scrollHeight;
            
            // åˆ›å»º AI å›å¤å ä½
            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai-message';
            aiDiv.textContent = 'æ­£åœ¨æ€è€ƒ...';
            history.appendChild(aiDiv);
            history.scrollTop = history.scrollHeight;
            
            try {
                // å‘é€è¯·æ±‚ï¼ˆåŒ…å«æåŠçš„ç¾¤ç»„ä¿¡æ¯ï¼‰
                const response = await fetch('chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: text,
                        mentions: mentions.map(g => ({name: g.name, prompt: g.prompt}))
                    })
                });
                
                if (response.status === 401) {
                    throw new Error("è¯·å…ˆç™»å½•");
                }
                
                // å¤„ç†æµå¼å“åº”
                aiDiv.textContent = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = '';

                // Make sure markdown renderer is available (or degrade safely)
                const canRenderMarkdown = await ensureMarked();
                if (!canRenderMarkdown) {
                    console.warn("[WARN] 'marked' is not available. Falling back to plain text rendering.");
                }
                await ensureHljs(); // best-effort
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, {stream: true});
                    accumulatedText += chunk;
                    
                    // å®æ—¶æ¸²æŸ“ Markdown
                    if (canRenderMarkdown && typeof marked !== 'undefined') {
                        aiDiv.innerHTML = marked.parse(accumulatedText);
                    } else {
                        aiDiv.textContent = accumulatedText;
                    }
                    
                    // é«˜äº®ä»£ç å—
                    if (typeof hljs !== 'undefined') {
                        aiDiv.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                    
                    history.scrollTop = history.scrollHeight;
                }
                
                // å¯¹è¯å®Œæˆåï¼Œæ›´æ–°å†å²ä¿¡æ¯
                updateHistoryInfo();
                
            } catch (error) {
                aiDiv.innerHTML = `<span style="color: red;">[å‘ç”Ÿé”™è¯¯: ${escapeHtml(error.message)}]</span>`;
            } finally {
                btn.disabled = false;
                input.focus();
            }
        }
        
        // HTML è½¬ä¹‰å‡½æ•°ï¼ˆé˜²æ­¢ XSSï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ­£åˆ™è¡¨è¾¾å¼è½¬ä¹‰å‡½æ•°
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // æ›´æ–°å†å²ä¿¡æ¯æ˜¾ç¤º
        async function updateHistoryInfo() {
            try {
                const response = await fetch('history_info');
                const data = await response.json();
                
                const infoDiv = document.getElementById('history-info');
                if (data.message_count > 0) {
                    infoDiv.textContent = `ğŸ’¬ å¯¹è¯å†å²: ${data.conversation_rounds} è½® (${data.message_count} æ¡æ¶ˆæ¯)`;
                    infoDiv.style.display = 'block';
                } else {
                    infoDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to update history info:', error);
            }
        }
        
        // æ¸…é™¤å¯¹è¯å†å²
        async function clearHistory() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²å—ï¼Ÿ\n\næ¸…é™¤åAIå°†ä¸å†è®°å¾—ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('clear_history', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'ok') {
                    // æ¸…é™¤ç•Œé¢æ˜¾ç¤º
                    document.getElementById('chat-history').innerHTML = '';
                    
                    // æ›´æ–°å†å²ä¿¡æ¯
                    updateHistoryInfo();
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    alert(`âœ… å·²æ¸…é™¤ ${data.removed} æ¡å†å²æ¶ˆæ¯`);
                }
            } catch (error) {
                alert('âŒ æ¸…é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('group-modal');
            if (event.target === modal) {
                closeGroupModal();
            }
        }
    </script>
</body>
</html>
